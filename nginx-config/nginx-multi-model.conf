# Multi-Model Nginx Gateway for vLLM
# Routes different models based on URL path
# Architecture: Single gateway â†’ Multiple vLLM backends

# ============================================================================
# UPSTREAM BACKENDS
# ============================================================================

# OCR Model Backend (Nanonets-OCR2-3B) - DISABLED (not running)
# upstream vllm_ocr {
#     least_conn;  # Load balancing method
#     server vllm-ocr:8000 max_fails=3 fail_timeout=30s;
# }

# Chandra OCR Model Backend (datalab-to/chandra) - DISABLED (not running)
# upstream vllm_chandra {
#     least_conn;
#     server vllm-chandra:8000 max_fails=3 fail_timeout=30s;
# }

# Text Generation Model Backend (Qwen2.5-1.5B-Instruct)
upstream vllm_text {
    least_conn;
    server vllm-text:8000 max_fails=3 fail_timeout=30s;
    # Add more replicas if needed:
    # server vllm-text-2:8000 max_fails=3 fail_timeout=30s;
}

# Qwen3-VL Model Backend (Qwen3-VL-30B-A3B-Instruct) - DISABLED (not running)
# upstream vllm_qwen3vl {
#     least_conn;
#     server vllm-qwen3vl:8000 max_fails=3 fail_timeout=30s;
# }

# HunyuanOCR Model Backend (tencent/HunyuanOCR)
upstream vllm_hunyuan_ocr {
    least_conn;
    server vllm-hunyuan-ocr:8000 max_fails=3 fail_timeout=30s;
}

# ============================================================================
# MAIN SERVER
# ============================================================================

server {
    listen 80;
    server_name _;

    # Use Docker's internal DNS resolver for dynamic upstream resolution
    # This allows nginx to resolve upstream hosts at request time, not startup
    resolver 127.0.0.11 valid=30s;

    # Increase timeouts for long-running requests
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    send_timeout 300s;

    # Increase body size for large images/documents
    client_max_body_size 50M;

    # ========================================================================
    # OCR MODEL ENDPOINTS
    # Path: /ocr/v1/*
    # ========================================================================
    location /ocr/ {
        # Remove /ocr prefix before forwarding
        rewrite ^/ocr/(.*) /$1 break;
        
        proxy_pass http://vllm_ocr;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Add custom header to identify backend
        add_header X-Model-Type ocr always;
        add_header X-Model-Name "nanonets/Nanonets-OCR2-3B" always;
    }

    # ========================================================================
    # CHANDRA OCR MODEL ENDPOINTS
    # Path: /chandra/v1/*
    # ========================================================================
    location /chandra/ {
        # Remove /chandra prefix before forwarding
        rewrite ^/chandra/(.*) /$1 break;
        
        proxy_pass http://vllm_chandra;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Add custom header to identify backend
        add_header X-Model-Type ocr always;
        add_header X-Model-Name "datalab-to/chandra" always;
    }

    # ========================================================================
    # TEXT MODEL ENDPOINTS
    # Path: /text/v1/*
    # ========================================================================
    location /text/ {
        # Remove /text prefix before forwarding
        rewrite ^/text/(.*) /$1 break;
        
        proxy_pass http://vllm_text;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Add custom header to identify backend
        add_header X-Model-Type text always;
        add_header X-Model-Name "Qwen/Qwen2.5-1.5B-Instruct" always;
    }

    # ========================================================================
    # QWEN3-VL MODEL ENDPOINTS
    # Path: /qwen3vl/v1/*
    # ========================================================================
    location /qwen3vl/ {
        # Remove /qwen3vl prefix before forwarding
        rewrite ^/qwen3vl/(.*) /$1 break;
        
        proxy_pass http://vllm_qwen3vl;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Add custom header to identify backend
        add_header X-Model-Type vision-language always;
        add_header X-Model-Name "Qwen/Qwen3-VL-30B-A3B-Instruct" always;
    }

    # ========================================================================
    # HUNYUANOCR MODEL ENDPOINTS
    # Path: /hunyuan/v1/*
    # ========================================================================
    location /hunyuan/ {
        # Remove /hunyuan prefix before forwarding
        rewrite ^/hunyuan/(.*) /$1 break;
        
        proxy_pass http://vllm_hunyuan_ocr;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Disable buffering for streaming responses
        proxy_buffering off;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Increase timeouts for OCR processing
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # Add custom header to identify backend
        add_header X-Model-Type ocr always;
        add_header X-Model-Name "tencent/HunyuanOCR" always;
    }

    # ========================================================================
    # HEALTH CHECK ENDPOINT
    # Returns status of all backends
    # ========================================================================
    location /health {
        access_log off;
        
        # Return simple health check
        # In production, you might want to check backend health
        return 200 "vLLM Multi-Model Gateway - Healthy\n";
        add_header Content-Type text/plain;
    }

    # ========================================================================
    # HEALTH CHECK FOR INDIVIDUAL BACKENDS
    # ========================================================================
    location /health/ocr {
        access_log off;
        rewrite ^/health/ocr$ /health break;
        proxy_pass http://vllm_ocr;
    }

    location /health/chandra {
        access_log off;
        rewrite ^/health/chandra$ /health break;
        proxy_pass http://vllm_chandra;
    }

    location /health/text {
        access_log off;
        rewrite ^/health/text$ /health break;
        proxy_pass http://vllm_text;
    }

    location /health/qwen3vl {
        access_log off;
        rewrite ^/health/qwen3vl$ /health break;
        proxy_pass http://vllm_qwen3vl;
    }

    location /health/hunyuan {
        access_log off;
        rewrite ^/health/hunyuan$ /health break;
        proxy_pass http://vllm_hunyuan_ocr;
    }

    # ========================================================================
    # METRICS ENDPOINTS (Optional - for monitoring)
    # ========================================================================
    location /metrics/ocr {
        access_log off;
        rewrite ^/metrics/ocr$ /metrics break;
        proxy_pass http://vllm_ocr;
    }

    location /metrics/chandra {
        access_log off;
        rewrite ^/metrics/chandra$ /metrics break;
        proxy_pass http://vllm_chandra;
    }

    location /metrics/text {
        access_log off;
        rewrite ^/metrics/text$ /metrics break;
        proxy_pass http://vllm_text;
    }

    location /metrics/qwen3vl {
        access_log off;
        rewrite ^/metrics/qwen3vl$ /metrics break;
        proxy_pass http://vllm_qwen3vl;
    }

    location /metrics/hunyuan {
        access_log off;
        rewrite ^/metrics/hunyuan$ /metrics break;
        proxy_pass http://vllm_hunyuan_ocr;
    }

    # ========================================================================
    # ROOT ENDPOINT - API Information
    # ========================================================================
    location = / {
        default_type application/json;
        return 200 '{
            "service": "vLLM Multi-Model Gateway",
            "version": "1.0",
            "models": {
                "ocr": {
                    "name": "nanonets/Nanonets-OCR2-3B",
                    "endpoint": "/ocr/v1/",
                    "type": "vision",
                    "health": "/health/ocr"
                },
                "chandra": {
                    "name": "datalab-to/chandra",
                    "endpoint": "/chandra/v1/",
                    "type": "vision",
                    "health": "/health/chandra",
                    "description": "Advanced OCR with superior table/handwriting recognition"
                },
                "text": {
                    "name": "Qwen/Qwen2.5-1.5B-Instruct",
                    "endpoint": "/text/v1/",
                    "type": "text",
                    "health": "/health/text"
                },
                "qwen3vl": {
                    "name": "Qwen/Qwen3-VL-30B-A3B-Instruct",
                    "endpoint": "/qwen3vl/v1/",
                    "type": "vision-language",
                    "health": "/health/qwen3vl",
                    "description": "Latest Qwen3 VL model with MoE architecture (30B params, 3.3B active)"
                },
                "hunyuan": {
                    "name": "tencent/HunyuanOCR",
                    "endpoint": "/hunyuan/v1/",
                    "type": "ocr",
                    "health": "/health/hunyuan",
                    "description": "End-to-end OCR expert VLM (1B params, lightweight)"
                }
            },
            "endpoints": {
                "ocr_chat": "/ocr/v1/chat/completions",
                "ocr_completions": "/ocr/v1/completions",
                "chandra_chat": "/chandra/v1/chat/completions",
                "chandra_completions": "/chandra/v1/completions",
                "text_chat": "/text/v1/chat/completions",
                "text_completions": "/text/v1/completions",
                "qwen3vl_chat": "/qwen3vl/v1/chat/completions",
                "qwen3vl_completions": "/qwen3vl/v1/completions",
                "hunyuan_chat": "/hunyuan/v1/chat/completions",
                "hunyuan_completions": "/hunyuan/v1/completions",
                "health": "/health",
                "metrics_ocr": "/metrics/ocr",
                "metrics_chandra": "/metrics/chandra",
                "metrics_text": "/metrics/text",
                "metrics_qwen3vl": "/metrics/qwen3vl",
                "metrics_hunyuan": "/metrics/hunyuan"
            }
        }\n';
    }

    # ========================================================================
    # LOGGING
    # ========================================================================
    access_log /var/log/nginx/vllm_access.log;
    error_log /var/log/nginx/vllm_error.log;
}

